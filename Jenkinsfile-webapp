def image_version="v${BUILD_NUMBER}"
pipeline{
    agent {label 'slave_agent'}
    stages {
        
        stage('build') {
            steps{
                sh './mvnw package -Dcheckstyle.skip'
            }
        }

        stage('upload image to ACR'){
            steps{
                withCredentials([usernamePassword(credentialsId:'acr_creds', passwordVariable: 'PASSWORD', usernameVariable: 'USERNAME')]) {
                    sh 'docker login myfirstprivateregistry.azurecr.io -u ${USERNAME} -p ${PASSWORD} '
                }
                sh "docker build . -t petclinic:${image_version}"
                sh "docker tag petclinic:${image_version} myfirstprivateregistry.azurecr.io/petclinic:${image_version}"
                sh "docker push myfirstprivateregistry.azurecr.io/petclinic:${image_version}"
                sh "docker rmi myfirstprivateregistry.azurecr.io/petclinic:${image_version}""
            }
        }
    }
}